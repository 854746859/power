<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta content="能源公社" http-equiv="keywords">
		<meta name="description" content="能源公社">
		<meta name="applicable-device" content="pc,mobile">
		<meta http-equiv="Cache-Control" content="no-siteapp" />
		<meta http-equiv="Cache-Control" content="no-transform" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<title>能源公社</title>
		<link rel="stylesheet" type="text/css" href="boostrap/css/bootstrapValidator.min.css" />
		<link rel="stylesheet" type="text/css" href="boostrap/css/bootstrap.min.css" />
		<!-- <link rel="stylesheet" type="text/css" href="css/index.css" /> -->
		<script type="text/javascript" src="js/jquery-1.11.0.min.js"></script>
		<script src="./boostrap/js/bootstrap.min.js"></script>
		<script src="./boostrap/js/bootstrapValidator.min.js"></script>
		<style type="text/css">
			body {
				margin: 0;
				padding: 0;
				background: url('images/login__.png') no-repeat;
				background-size: 100% 100%;
				background-attachment: fixed;
				font-family: PingFang SC;
			}

			input {
				background: none;
				outline: none;
				border: none;
				padding-right: 0px !important;
			}

			.contain {
				float: right;
				margin-top: 30px;
				min-width: 400px;
				width: 30%;
				height: 89vh;
			}

			.title {
				display: flex;
				flex-direction: row;
				align-items: flex-end;
				font-size: 48px;
				line-height: 48px;
				color: #1DBCB8;
				margin-top: 80px;
				font-family: "Microsoft Yahei", '黑体', helvetica, tahoma, arial, sans-serif;
			}

			.title .min {
				font-size: 38px;
				line-height: 38px;
			}

			.title_second {
				font-size: 26px;
				color: #333;
				font-weight: bold;
				margin-top: 16px;
				margin-bottom: 16px;
			}

			.login_body {
				display: flex;
				flex-direction: row;
				position: relative;
				align-items: flex-start;
			}

			.input_box {
				min-width: 380px;
				display: flex;
				flex-direction: column;
				align-items: flex-end;
			}

			.put_in {
				display: flex;
				flex-direction: row;
				align-items: center;
				margin-top: 25px;
			}

			.put_in span {
				font-size: 16px;
				color: #707070;
			}

			.put_in input {
				width: 273px;
				height: 30px;
				border: 1px solid rgba(112, 112, 112, 1);
				opacity: 1;
				padding-left: 5px;
			}

			.more {
				display: flex;
				flex-direction: column;
				align-items: flex-start;
				font-size: 12px;
			}

			.more .tips {
				margin: 10px 0 0 0;
			}

			.more a {
				line-height: 13px;
				color: rgba(15, 114, 232, 1);
				text-decoration: none;
			}

			.bt_box {
				display: flex;
				flex-direction: row;
				width: 70%;
				margin-top: 15px;
				justify-content: space-around;
			}

			.bt_box input {
				width: 60%;
				height: 40px;
				background: rgba(29, 188, 184, 1);
				opacity: 1;
				border-radius: 6px;
				color: #fff;
			}

			.protocol {
				display: flex;
				align-items: center;
				cursor: pointer;
			}
			.protocol span{
				font-size: 13px;
				line-height: 13px;
			}
			.smsbtn{
				display: flex;
				justify-content: center;
				align-items: center;
				text-align: center;
				background-color: #1DBCB8;
				color: #fff;
				padding: 0px 12px;
				margin-left: 12px;
				height: 28;
				border-radius: 4px;
				font-size: 10px;
			}
			.notclick{
			  pointer-events: none;
			}

			.btn-primary {
				display: flex;
				justify-content: center;
				align-items: center;
				text-align: center;
				background-color: #1DBCB8;
				color: #fff;
				width: 240px;
				border-radius: 4px;
				font-size: 16px;
				border: none;
			}
		</style>
	</head>
	<body>
		<div class="contain">
			<div class="alert alert-danger alert-dismissable" id="showErrno" style="display: none;position: absolute;width: 450px;right: 0px;">
				<button type="button" class="close" data-dismiss="alert" aria-hidden="true">
						&times;
				</button>
				<div id="erronText">错误！请进行一些更改。</div>				
			</div>
			<div class="login_box">
				<div class="title">
					<div class="max">能源公社</div>
					<div class="min">欢迎您</div>
				</div>
				<div class="title_second">
					用户注册
				</div>
				<div class="login_body">
					<!-- <div class="input_box"> -->
					<form style="width: 320px;">
						<div class="form-group">
							<label>账号</label>
							<input id="user_account" type="text" value="" class="form-control" name="username" />
						</div>
						<div class="form-group">
							<label>密码</label>
							<input id="user_password" name="user_password" type="password" value="" class="form-control" />
						</div>
						<div class="form-group">
							<label>确认密码</label>
							<input id="user_password_again" name="user_password_again" type="password" value="" class="form-control" />
						</div>
						<div class="form-group">
							<label>邮箱</label>
							<input id="user_mailbox" name="user_mailbox" type="email" value="" class="form-control" />
						</div>
						<div class="form-group">
							<label>手机号码</label>
							<div style="display: flex;justify-content: space-between;">
								<input id="user_phone" style="width: 240px;" name="user_phone" type="number" value="" class="form-control" />
								<div class="smsbtn" id="code">
									发送
								</div>
							</div>
							
						</div>
						<div class="form-group">
							<label>验证码</label>
							<input id="the_code" name="the_code" type="number" value="" class="form-control" />
						</div>
						<div class="more">
							<div class="protocol">
								<input type="checkbox" style="margin-top: 0px; margin-right: 6px;" name="" id="" checked value="" id="check" /><span>我已阅读并同意服务条款点击阅读</span><a class="protocol" id="protocol">注册协议</a>
							</div>
							<div class="tips">
								tips：实名注册可获得论坛币、可发起提问，能更好体验哦
							</div>
						</div>
						<div class="form-group" style="display: flex; justify-content: center;">
							<div class="bt_box">
								<button type="submit" name="submit" id="submit" class="btn btn-primary">注册</button>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>
		<script type="text/javascript" src="config.js"></script>
		<script type="text/javascript" src="js/pop_ups/MiniDialog-es5.min.js"></script>
		<script type="text/javascript">
			//协议
			$("#protocol").click(function() {
				window.open("protocol.html", "newwindow",
					"height=600, width=960, top=300, left=500, toolbar=no, menubar=no, scrollbars=no, resizable=no,location=no, status=no"
				)
			})
			
			//60s倒计时
			function countDown(seconds) {
				var txt = ((seconds < 10) ? "0" + seconds : seconds);
				console.log(seconds--)
				let next_seconds = seconds-- 
				$("#code").html("重新发送(" + txt + ")");
				var timeId = setTimeout(function(){
					countDown(next_seconds)
				}, 1000);
				if (seconds == 0) {
					clearTimeout(timeId);
					$("#code").html("发送");
					$("#code").removeClass("notclick")
				};
			}

			$(function() {
				$('form').bootstrapValidator({
					message: 'This value is not valid',
					
					fields: {
						username: {
							message: '用户名验证失败',
							validators: {
								notEmpty: {
									message: '用户名不能为空'
								},
								regexp: {
									regexp: /^[a-zA-Z0-9_]+$/,
									message: '用户名只能包含大写、小写、数字和下划线'
								}
							}
						},
						user_password: {
							validators: {
								notEmpty: {
									message: '密码不能为空'
								},
								stringLength: {
										min: 6,
										max: 18,
										message: '用户名长度必须在6到18位之间'
								}
							}
						},
						user_password_again: {
							validators: {
								notEmpty: {
									message: '确认密码不能为空'
								},
								stringLength: {
										min: 6,
										max: 18,
										message: '用户名长度必须在6到18位之间'
								}
							}
						},
						user_mailbox: {
							validators: {
								notEmpty: {
									message: '邮箱不能为空'
								},
								emailAddress: {
									message: '邮箱地址格式有误'
								}
							}
						},
						user_phone: {
							validators: {
								notEmpty: {
									message: '手机号码不能为空'
								},
								regexp: {
									regexp: /^1[3456789]\d{9}$/,
									message: '手机号码格式错误'
								}
							}
						},
						the_code: {
							validators: {
								notEmpty: {
									message: '验证码不能为空'
								}
							}
						}
					}
				});
			});
			
			// 验证手机号
				function checkMobile(str) {
					let re = /^1\d{10}$/
					if (re.test(str)) {
						return true;
					} else {
						return false;
					}
				}
				
				$("#user_phone").focus(function() {
					$("#showErrno").hide()
				})
				
				$("#user_password_again").focus(function() {
					$("#showErrno").hide()
				})

				//获取验证码
				$("#code").click(function() {
					let phone = $("#user_phone").val()
					if(phone != ''){
						if(checkMobile(phone)){
							countDown(59)
							$("#code").addClass("notclick")
							$("#code").attr("disabled", true);
							$.ajax({
								type: "post",
								url: sever_url + "sendSms",
								async: true,
								data: {
									phone: $("#user_phone").val()
								},
								dataType: "json",
								success: function(data) {
									console.log(data)
								}
							});
						}else{
							$("#erronText").html("错误！手机号码有误")
							$("#showErrno").show()
						}
					}else{
						$("#erronText").html("错误！手机号码不能为空")
						$("#showErrno").show()
					}					
				})
				
				

				$("#submit").click(function() {
					console.log(window.history.length)
					if($("#user_password").val() != $("#user_password_again").val()){
						$("#erronText").html("错误！两次密码不一致")
						$("#showErrno").show()
					}else{
						$.ajax({
							type: "post",
							url: sever_url + "reg",
							async: true,
							data: {
								user_account: $("#user_account").val(),
								user_password: $("#user_password").val(),
								user_mailbox: $("#user_mailbox").val(),
								user_phone: $("#user_phone").val(),
								code: $("#the_code").val()
							},
							dataType: "json",
							success: function(data) {
								console.log(data)
								if (data.code == "200") {
									$.ajax({
										type: "post",
										url: sever_url + "login",
										async: true,
										data: {
											user_account: $("#user_account").val(),
											user_password: $("#user_password").val()
										},
										dataType: "json",
										success: function(data) {
											console.log(data)
											if (data.code == '200') {
												var obj = JSON.stringify(data.data);
												sessionStorage.setItem("data", obj);
												if(window.history.length < 2){
													window.location.href="mine.html";
												}else{
													window.history.go(-2);
												}
												
											}
										}
									});
								} else {
									$("#erronText").html(`错误！${data.msg}`)
									$("#showErrno").show()
								}
							},
							error: function() {
						
							}
						});
					}					
				})
		</script>
	</body>
</html>
